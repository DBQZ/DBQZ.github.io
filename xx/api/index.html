<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Excel查询</title>
</head>
<body>
    <textarea id="result" cols="30" rows="10" readonly></textarea>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/jszip.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <script>
        let workbook;

        // 获取URL参数
        function getParameterByName(name, url) {
            if (!url) url = window.location.href;
            name = name.replace(/[\[\]]/g, '\\$&');
            var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
                results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, ' '));
        }

        document.addEventListener('DOMContentLoaded', function() {
            const filePath = 'https://dbqz.xyz/xx/sqlhtmlwebapp.xlsx';

            // 加载Excel文件
            fetch(filePath)
                .then(response => response.arrayBuffer())
                .then(data => {
                    workbook = XLSX.read(data, { type: 'array' });
                    
                    // 检查URL参数并在页面加载时自动执行搜索
                    const nameFromURL = getParameterByName('name');
                    if (nameFromURL) {
                        searchForName(nameFromURL);
                    }
                })
                .catch(error => console.error('Error:', error));
        });

        // 查询函数
        function searchForName(name) {
            if (name === '') {
                alert('请输入姓名');
                return;
            }
            if (!workbook) {
                alert('未加载');
                return;
            }
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
            const headers = jsonData[0];
            const rows = jsonData.slice(1);
            const result = rows.find(row => row.includes(name));
            if (result) {
                let resultText = '';
                for (let i = 0; i < result.length; i++) {
                    const headerText = headers[i] === "姓名" ? "学生姓名" : headers[i];
                    resultText += `${headerText}: ${result[i]}\n`;
                }
                document.getElementById('result').value = resultText;
                
                // 更改网页标题为查询到的学生姓名
                document.title = `查询结果 - ${result[0]}`;
                
                // 输出纯文本结果
                document.write(resultText);
                document.close();
            } else {
                document.getElementById('result').value = '未找到该生的信息';
                document.title = '查询结果 - 未找到';
                document.write('未找到该生的信息');
            }
        }
    </script>
</body>
</html>